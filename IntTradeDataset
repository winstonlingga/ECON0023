import pandas as pd
import os
from functools import reduce

# 1. Loading my data
base_path = os.path.join(os.getcwd(), "Data")

tourism = pd.read_csv(os.path.join(base_path, "tourism.csv"))
average_monthly_exp = pd.read_csv(os.path.join(base_path, "average_monthly_exp.csv"))
cpi = pd.read_csv(os.path.join(base_path, "cpi_housing.csv"))
disp_income = pd.read_csv(os.path.join(base_path, "disp_income.csv"))

# 2. Keeping the relevant companies 
def keep_relevant_columns(df):
    observation_cols = [col for col in df.columns if col.startswith("Observation_")]
    return df[["Territory", "Year"] + observation_cols]

tourism = keep_relevant_columns(tourism)
average_monthly_exp = keep_relevant_columns(average_monthly_exp)
cpi = keep_relevant_columns(cpi)
disp_income = keep_relevant_columns(disp_income)

# 3. Cleaning territory names
region_map = {
    "Piemonte": "Piemonte",
    "Liguria": "Liguria",
    "Lombardia": "Lombardia",
    "Veneto": "Veneto",
    "Emilia-Romagna": "Emilia-Romagna",
    "Toscana": "Toscana",
    "Umbria": "Umbria",
    "Marche": "Marche",
    "Lazio": "Lazio",
    "Abruzzo": "Abruzzo",
    "Molise": "Molise",
    "Campania": "Campania",
    "Puglia": "Puglia",
    "Basilicata": "Basilicata",
    "Calabria": "Calabria",
    "Sicilia": "Sicilia",
    "Sardegna": "Sardegna",
    "Valle d'Aosta": "Valle d'Aosta",
    "Valle d’Aosta": "Valle d'Aosta",
    "Vallée d'Aoste": "Valle d'Aosta",
    "Friuli Venezia Giulia": "Friuli-Venezia Giulia",
    "Trentino Alto Adige": "Trentino Alto Adige",
}

def clean_regions(df):
    df["Territory"] = df["Territory"].map(region_map).fillna(df["Territory"])
    return df

tourism = clean_regions(tourism)
average_monthly_exp = clean_regions(average_monthly_exp)
cpi = clean_regions(cpi)
disp_income = clean_regions(disp_income)

for df in [tourism, average_monthly_exp, cpi, disp_income]:
    df["Year"] = pd.to_numeric(df["Year"], errors="coerce").astype("Int64")

# 5. Merging my data
dfs = [tourism, average_monthly_exp, cpi, disp_income]

final_df = reduce(
    lambda left, right: pd.merge(left, right, on=["Territory", "Year"], how="outer"),
    dfs
)

final_df = final_df.sort_values(["Territory", "Year"]).reset_index(drop=True)

# Removing useless regions
final_df = final_df[~final_df["Territory"].isin(["Region not specified", "Italy"])]

# 7. Final dataset

final_df.to_csv("final_dataset.csv", index=False)
# final_df.to_excel("final_dataset.xlsx", index=False)

print("Final dataset saved!")

print(final_df.head())
final_df.to_csv("final_dataset.csv", index=False)

